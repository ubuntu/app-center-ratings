version: "3.5"

services:
  db:
    container_name: ratings-db
    build: ./docker/database
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "@1234"
      PGPASSWORD: "@1234" # Used by "sudo make db-shell"
      MIGRATION_USER: "migration_user"
      MIGRATION_PASSWORD: "strongpassword"
      SERVICE_USER: "service"
      SERVICE_PASSWORD: "covfefe!1"
      RATINGS_DB: "ratings"

  ratings:
    container_name: ratings
    build: ./docker/ratings
    ports:
      - 8080:8080
    environment:
      RUST_LOG: "info,hyper=error"
      APP_LOG_LEVEL: "info"
      APP_ENV: "dev"
      APP_HOST: "0.0.0.0"
      APP_JWT_SECRET: "deadbeef"
      APP_NAME: "ratings"
      APP_PORT: "8080"
      APP_POSTGRES_URI: "postgresql://migration_user:strongpassword@db:5432/ratings"
      APP_ADMIN_USER: "shadow"
      APP_ADMIN_PASSWORD: "maria"
    volumes:
      - /run/snapd.socket:/run/snapd.socket
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    entrypoint: "cargo watch -x run"
    depends_on:
      - db

volumes:
  cargo-cache: null
  target-cache: null
